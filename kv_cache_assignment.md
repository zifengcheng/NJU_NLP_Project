# 大作业题目：多段预处理文本的 KV 缓存融合与重建策略研究

## 一、背景与动机

在多段文档问答或多来源文本生成任务中，系统往往需要同时引入多个信息段落作为上下文。传统方法将所有段落拼接为一个长文本输入 LLM，推理时完整计算 KV Cache，虽效果好但推理成本极高。

一种更高效的做法是：将每个段落单独预处理生成 KV Cache，然后在生成阶段融合这些段落的 KV。但由于这些 KV 是独立生成的，它们之间缺少交叉 Attention 信息，若直接拼接会显著影响生成质量。

因此，本项目聚焦于探索如何融合多个段落的预处理 KV Cache，并通过选择性重建交叉注意力来恢复上下文联系，从而尽可能逼近全串联推理效果，且推理效率更高。

## 二、任务目标

1. **多段落 KV Cache 的预计算与拼接机制**  
   实现段落独立处理并缓存 KV，并拼接为接近真实上下文的输入；需处理位置编码、attention mask 等细节。

2. **交叉注意力重建机制**  
   分析哪些 KV 缺失交叉 Attention，通过选择性重计算部分 Attention 以更新 KV，使整体效果更接近串联输入的推理结果。

3. **精度-效率权衡分析**  
   在不同重建强度下评估生成质量与计算效率，分析拼接与重建的影响。

> 推荐模型：LLaMA2-7B、Mistral-7B  
> 要求使用 PyTorch 框架写代码

## 三、实验设置建议

| 实验维度   | 建议配置                    |
|------------|-----------------------------|
| 拼接段落数 | 根据数据集或者自己划分     |
| 重建比例   | 自行设计                    |
| 数据集     | 2WikiMultiHopQA / SAMSum 等 |
| 测试指标   | 重建时间 / 测试集正确率等  |

**可视化建议**  
- 生成内容对比  
- 交叉注意力 map  
- 策略效果热图等

## 四、评分标准（共 100 分）

| 维度       | 分数 | 说明 |
|------------|------|------|
| 实现能力   | 20   | 是否实现多段 KV 拼接、位置编码处理、重计算模块等关键部分 |
| 策略设计   | 25   | 融合策略是否合理、创新，是否对 KV 重建范围有明确逻辑与目标 |
| 实验对比   | 25   | 不同重算比例 / 拼接策略对性能与生成质量的影响是否充分分析 |
| 创新性     | 20   | 是否设计出更细粒度的融合机制或重建判定机制 |
| 表达与结构 | 10   | 报告清晰、图表齐全、结论有启发性 |

## 五、提交内容

### 代码

1. 代码结构不做要求  
2. 要给出能够运行的 python 环境（`requirements.txt`）  
3. 要给出能成功运行代码的脚本

### 报告

- 实现方法：详细描述实现方法  
- 实验结果：展示几种条件下的生成结果  
- 结果分析：对以上实验结果进行分析  

> 如有引用参考文献，请在报告中列出相关文献。  
> 有任何疑问，请联系：liang_000821@163.com
